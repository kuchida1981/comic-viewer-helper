# Comic Viewer Helper コードレビューレポート

## 概要

本プロジェクトは、特定の漫画サイト向けのUserScript/Browser Extensionであり、TypeScript, Vite, Vitestを用いたモダンな開発環境で構築されています。
全体として、UserScriptとしては非常に堅牢で拡張性の高いアーキテクチャが採用されており、品質は高い水準にあります。

## 1. 良い点 (Strengths)

### 1.1 アーキテクチャと設計
*   **明確な責務分離:**
    *   **Store (State Management):** Pub/Subパターンを用いた独自の状態管理クラス (`Store.ts`) があり、アプリケーションの状態を一元管理しています。これにより、UIとロジックの同期が容易になっています。
    *   **Managers:** `Navigator` (ページ操作), `UIManager` (表示), `InputManager` (入力) と機能ごとにクラスが分かれており、単一責任の原則が守られています。
    *   **Adapter Pattern:** `SiteAdapter` インターフェースと `DefaultAdapter` により、サイト固有のDOM構造への依存が切り出されています。将来的な他サイト対応や、サイト側の構造変更への追従が容易です。
*   **ロジックの分離:**
    *   `src/logic.ts` に純粋関数 (Pure Functions) が集約されています。DOMの状態に依存しない計算ロジック（ペアリング判定、インデックス計算など）として実装されているため、単体テストが非常に書きやすくなっています。

### 1.2 技術選定と品質管理
*   **TypeScriptの活用:** `strict: true` 設定の下、型安全性が確保されています。特に `StoreState` や `SiteAdapter` の型定義により、開発時のミスを未然に防いでいます。
*   **テスト戦略:** Vitest と JSDOM を組み合わせ、ロジックだけでなく、DOM操作を含むコンポーネントのテストも可能な環境が整っています。`.safety.test.ts` のような安全性検証用のテストも存在します。
*   **モダンな構成:** ESLint (Flat Config) や Vite のビルドスクリプトなど、最新のフロントエンド開発のエコシステムを取り入れています。

## 2. 改善の余地 (Areas for Improvement)

### 2.1 UI実装のアプローチ
*   **命令的UI構築:** `UIManager.ts` では `document.createElement` を多用してDOMを構築しています。現状の規模なら管理可能ですが、機能追加に伴い `updateUI` メソッドが肥大化し、可読性と保守性が低下するリスクがあります。
    *   **リスク:** UIの状態変化（ローディング、エラー、モーダル開閉）の組み合わせが増えると、DOMの更新ロジックが複雑になります。

### 2.2 エラーハンドリングと堅牢性
*   **DOM依存の脆さ:** `DefaultAdapter` は特定のIDやクラス名 (`#post-comic`, `.post-list-image`) に強く依存しています。サイト側のHTML構造が変わった際、単に動かなくなる可能性があります。
    *   **現状:** コンテナが見つからない場合は単にリターンするなど、静かに失敗する傾向があります。
*   **エラーフィードバック:** 画像ロードエラーや検索失敗時、`console.error` に出力されていますが、ユーザー向けのUIフィードバック（トースト通知やエラーメッセージ表示）が十分でない可能性があります。

### 2.3 パフォーマンス
*   **DOM再構築:** `Navigator.ts` の `applyLayout` メソッドは、レイアウト変更時に `revertToOriginal` を呼び出してDOMを初期状態に戻してから再構築しているように見えます。画像枚数が数百枚単位になると、この処理は重くなる可能性があります。

## 3. 具体的な改善提案 (Actionable Improvements)

### 3.1 短期的な改善（即効性あり）
1.  **UI構築のリファクタリング:**
    *   `UIManager` 内のDOM生成処理を、小さな再利用可能な関数（またはクラス）にさらに分割する。
    *   テンプレートリテラル等を活用し、HTML構造が見えやすい形にする。
2.  **ユーザーへのエラー通知強化:**
    *   必須要素（コンテナなど）が見つからない場合、画面上に「対応していないページ形式です」等のアラートを表示する機能を追加する。
3.  **定数の整理:**
    *   CSSクラス名やタイムアウト値、ローカルストレージのキーなどを `constants.ts` 等に集約し、マジックナンバー/ストリングを排除する。

### 3.2 中長期的な改善
1.  **軽量UIライブラリの導入:**
    *   Preact などの軽量ライブラリを導入し、UIを宣言的に記述する（JSX/TSXの活用）。UserScriptとしてのファイルサイズ増大とのトレードオフになりますが、保守性は劇的に向上します。
2.  **Adapterの動的解決:**
    *   現状 `App.ts` でアダプター配列を持っていますが、対応サイトが増えた場合に備え、URLパターンから適切なアダプターを解決する `AdapterRegistry` のような仕組みを導入する。

## 4. 改善によって得られるメリット

*   **開発効率の向上:** UIコードの宣言的記述やロジックのさらなる分離により、新機能追加時の工数が削減されます。
*   **品質の安定:** エラーハンドリング強化により、サイト側の変更やネットワークエラーに対する耐性が高まり、ユーザー体験が向上します。
*   **保守性の維持:** Adapterパターンの徹底とUIコードの整理により、長期間メンテナンス可能なコードベースを維持できます。
