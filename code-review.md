# コードレビューレポート: comic-viewer-helper

## 1. 概要
本プロジェクトは、特定のコミックサイト向けの Tampermonkey ユーザースクリプトとして、非常に整理された構造を持っています。特に、テストのしやすさを考慮してロジック (`logic.js`) と UI/イベントハンドリング (`main.js`) を分離している点は、ユーザースクリプト開発におけるベストプラクティスに従っており、高く評価できます。

## 2. コード品質

### 良い点
- **モジュール分割**: `logic.js` に純粋な関数（DOM操作を含むが、依存性が限定的）をまとめ、`main.js` で副作用を管理する構成。
- **ドキュメント**: JSDoc (`@type`, `@param`, `@returns`) が適切に記述されており、型安全性が意識されています。
- **パフォーマンス**: `requestAnimationFrame` を使用して、スクロールやリサイズイベントのハンドリングを最適化しています。
- **堅牢性**: 画像の `complete` 状態のチェックや、`resize` 時の `currentVisibleIndex` の保持など、ユーザー体験を損なわないための工夫が見られます。

### 改善の余地
- **UI構築の冗長性**: `createNavigationUI` 関数内で `document.createElement` と `Object.assign` が多用されており、可読性が低くなっています。
- **マジックナンバー/文字列**: `STORAGE_KEY_*` や `IMG_SELECTOR` などの定数は定義されていますが、ボタンのラベルやスタイル（色、サイズ）などの設定値が関数内に直接書き込まれています。
- **副作用の大きさ**: `fitImagesToViewport` が DOM 構造を大きく書き換えるため、他のスクリプトとの競合や、予期せぬ動作（スクロール位置の微細なズレなど）の原因になりやすい構造です。

## 3. テスト戦略

### 現状の評価
- **`logic.js` の網羅性**: カバレッジ 100% を達成しており、コアロジック（見開きの判定、可視領域の計算、ナビゲーションの方向）は非常に安定しています。
- **Vitest の活用**: `vi.stubGlobal` を使用して DOM API をモックし、環境に依存しないテストを実現しています。

### 今後の提案
- **`main.js` のテスト**: 現在、`main.js` はテストされていません。UI の生成ロジックや、イベントリスナーが正しくバインドされるかを確認するインテグレーションテスト（JSDOM を使用）の導入を検討してください。
- **エッジケースの追加**:
    - 非常に縦長の画像や、極端に小さい画像が混ざった場合の挙動。
    - ストレージが破損（`JSON.parse` 失敗時など）している場合のフォールバック。

## 4. リファクタリング対象の整理

優先度の高い順に以下のリファクタリングを推奨します。

### ① UI構築ロジックの整理 (`main.js`)
`createNavigationUI` が巨大なひとつの関数になっているため、コンポーネント単位で分割することを推奨します。
- `createButton(text, title, action)` のようなユーティリティ関数の作成。
- HTML テンプレート文字列（または `innerHTML` を安全に使うための仕組み）の活用による、構造の視覚化。

### ② ステート管理の集約
`isEnabled`, `isDualViewEnabled`, `spreadOffset` などの状態が、グローバル変数として散在しています。
```javascript
const state = {
  enabled: ...,
  dualView: ...,
  spreadOffset: ...,
  currentIndex: ...
};
```
のようにひとつのオブジェクトにまとめ、状態変更時に `localStorage` への保存や UI の更新を自動で行うようにすると、不整合を防げます。

### ③ スタイルの定数化 / CSS クラスの活用
`Object.assign(container.style, { ... })` でインラインスタイルを記述するのではなく、`header.js` または `main.js` の冒頭で一括して `<style>` タグとして注入し、JS 側では `classList` の操作に留めることで、見た目とロジックを分離できます。

### ④ エラーハンドリングの強化
`localStorage.getItem` や `document.querySelector` の結果に対する null チェックは行われていますが、`applyLayout` などの主要なフローで例外が発生した場合の回復処理（リセットボタンの提供など）があると、よりユーザーフレンドリーになります。

## 5. 結論
現状でも十分に高品質でメンテナンス性の高いコードですが、UI 周りの実装を整理することで、将来的な機能追加（設定画面の拡張など）がより容易になると考えられます。
特に、`logic.js` のテスト品質が非常に高いため、この方針を UI 側にも広げていくことが次のステップとして理想的です。
