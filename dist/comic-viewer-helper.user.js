// ==UserScript==
// @name         Magazine Comic Viewer Helper
// @namespace    https://github.com/kuchida1981/comic-viewer-helper
// @version      1.0.0
// @description  A Tampermonkey script for specific comic sites that fits images to the viewport and enables precise image-by-image scrolling.
// @match        https://something/magazine/*
// @match        https://something/fanzine/*
// @run-at       document-idle
// @grant        none
// ==/UserScript==

/**
 * ⚠️ DO NOT EDIT THIS FILE DIRECTLY ⚠️
 * This file is automatically generated by the build process.
 * Please edit files in the `src/` directory instead and run `npm run build`.
 */
(function() {
  "use strict";
  function calculateVisibleHeight(rect, windowHeight) {
    const visibleTop = Math.max(0, rect.top);
    const visibleBottom = Math.min(windowHeight, rect.bottom);
    return Math.max(0, visibleBottom - visibleTop);
  }
  function shouldPairWithNext(current, next, isDualViewEnabled2) {
    if (!isDualViewEnabled2) return false;
    if (current.isLandscape) return false;
    if (!next) return false;
    if (next.isLandscape) return false;
    return true;
  }
  function getPrimaryVisibleImageIndex(imgs, windowHeight) {
    if (imgs.length === 0) return -1;
    let maxVisibleHeight = 0;
    let primaryIndex = -1;
    imgs.forEach((img, index) => {
      const rect = img.getBoundingClientRect();
      const visibleHeight = calculateVisibleHeight(rect, windowHeight);
      if (visibleHeight > maxVisibleHeight) {
        maxVisibleHeight = visibleHeight;
        primaryIndex = index;
      }
    });
    return primaryIndex;
  }
  function getImageElementByIndex(imgs, index) {
    if (index < 0 || index >= imgs.length) return null;
    return imgs[index];
  }
  function cleanupDOM(container) {
    const allImages = Array.from(container.querySelectorAll("img"));
    const wrappers = container.querySelectorAll(".comic-row-wrapper");
    wrappers.forEach((w) => w.remove());
    allImages.forEach((img) => {
      img.style.cssText = "";
    });
    return allImages;
  }
  function fitImagesToViewport(containerSelector, spreadOffset2 = 0, isDualViewEnabled2 = false) {
    const container = document.querySelector(containerSelector);
    if (!container) return;
    const allImages = cleanupDOM(container);
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    Object.assign(container.style, {
      display: "flex",
      flexDirection: "column",
      alignItems: "center",
      padding: "0",
      margin: "0",
      width: "100%",
      maxWidth: "none"
    });
    for (let i = 0; i < allImages.length; i++) {
      const img = allImages[i];
      const isLandscape = img.naturalWidth > img.naturalHeight;
      let pairWithNext = false;
      const effectiveIndex = i - spreadOffset2;
      const isPairingPosition = effectiveIndex >= 0 && effectiveIndex % 2 === 0;
      if (isDualViewEnabled2 && isPairingPosition && i + 1 < allImages.length) {
        const nextImg = allImages[i + 1];
        const nextIsLandscape = nextImg.naturalWidth > nextImg.naturalHeight;
        if (shouldPairWithNext({ isLandscape }, { isLandscape: nextIsLandscape }, isDualViewEnabled2)) {
          pairWithNext = true;
        }
      }
      if (pairWithNext) {
        const nextImg = allImages[i + 1];
        const row = document.createElement("div");
        row.className = "comic-row-wrapper";
        Object.assign(row.style, {
          display: "flex",
          flexDirection: "row-reverse",
          justifyContent: "center",
          alignItems: "center",
          width: "100vw",
          maxWidth: "100vw",
          marginLeft: "calc(50% - 50vw)",
          marginRight: "calc(50% - 50vw)",
          height: "100vh",
          marginBottom: "0",
          position: "relative",
          boxSizing: "border-box"
        });
        [img, nextImg].forEach((im) => {
          Object.assign(im.style, {
            maxWidth: "50%",
            maxHeight: "100%",
            width: "auto",
            height: "auto",
            objectFit: "contain",
            margin: "0",
            display: "block"
          });
        });
        row.appendChild(img);
        row.appendChild(nextImg);
        container.appendChild(row);
        i++;
      } else {
        img.style.cssText = "";
        Object.assign(img.style, {
          maxWidth: `${vw}px`,
          maxHeight: `${vh}px`,
          width: "auto",
          height: "auto",
          display: "block",
          margin: "0 auto",
          flexShrink: "0",
          objectFit: "contain"
        });
        container.appendChild(img);
      }
    }
  }
  function revertToOriginal(originalImages2, containerSelector) {
    const container = document.querySelector(containerSelector);
    if (!container) return;
    container.style.cssText = "";
    originalImages2.forEach((img) => {
      img.style.cssText = "";
      container.appendChild(img);
    });
    const wrappers = container.querySelectorAll(".comic-row-wrapper");
    wrappers.forEach((w) => w.remove());
  }
  console.log("Magazine Comic View Helper Loaded");
  const IMG_SELECTOR = "#post-comic img";
  const CONTAINER_SELECTOR = "#post-comic";
  const STORAGE_KEY_DUAL_VIEW = "comic-viewer-helper-dual-view";
  const STORAGE_KEY_GUI_POS = "comic-viewer-helper-gui-pos";
  const STORAGE_KEY_ENABLED = "comic-viewer-helper-enabled";
  let pageCounter = null;
  let isDualViewEnabled = localStorage.getItem(STORAGE_KEY_DUAL_VIEW) === "true";
  let isEnabled = localStorage.getItem(STORAGE_KEY_ENABLED) !== "false";
  let originalImages = [];
  let spreadOffset = 0;
  function isInputField(target) {
    return target instanceof HTMLInputElement || target instanceof HTMLTextAreaElement || target instanceof HTMLSelectElement || target.isContentEditable;
  }
  function getImages() {
    if (originalImages.length > 0) return originalImages;
    return Array.from(document.querySelectorAll(IMG_SELECTOR));
  }
  function updatePageCounter() {
    if (!isEnabled) return;
    if (!pageCounter) return;
    const imgs = getImages();
    const totalEl = document.getElementById("comic-total-counter");
    if (imgs.length === 0) {
      pageCounter.value = 0;
      if (totalEl) totalEl.textContent = " / 0";
      return;
    }
    const currentIndex = getPrimaryVisibleImageIndex(imgs, window.innerHeight);
    const current = currentIndex !== -1 ? currentIndex + 1 : 1;
    const total = imgs.length;
    if (document.activeElement !== pageCounter) {
      pageCounter.value = current;
    }
    if (totalEl) totalEl.textContent = ` / ${total}`;
  }
  function jumpToPage(pageNumber) {
    const imgs = getImages();
    const index = parseInt(pageNumber, 10) - 1;
    const targetImg = getImageElementByIndex(imgs, index);
    if (targetImg) {
      targetImg.scrollIntoView({ behavior: "smooth", block: "center" });
      pageCounter.blur();
    } else {
      updatePageCounter();
      pageCounter.style.backgroundColor = "rgba(255, 0, 0, 0.3)";
      setTimeout(() => {
        pageCounter.style.backgroundColor = "transparent";
      }, 500);
      pageCounter.blur();
    }
  }
  function scrollToImage(direction) {
    const imgs = getImages();
    if (imgs.length === 0) return;
    const currentIndex = getPrimaryVisibleImageIndex(imgs, window.innerHeight);
    let targetIndex = currentIndex + direction;
    if (targetIndex < 0) targetIndex = 0;
    if (targetIndex >= imgs.length) targetIndex = imgs.length - 1;
    const prospectiveTargetImg = imgs[targetIndex];
    if (isDualViewEnabled && direction !== 0 && currentIndex !== -1) {
      const currentImg = imgs[currentIndex];
      if (currentImg && prospectiveTargetImg && prospectiveTargetImg.parentElement === currentImg.parentElement && prospectiveTargetImg.parentElement.classList.contains("comic-row-wrapper")) {
        targetIndex += direction;
      }
    }
    const finalIndex = Math.max(0, Math.min(targetIndex, imgs.length - 1));
    const finalTarget = imgs[finalIndex];
    if (finalTarget) {
      finalTarget.scrollIntoView({ behavior: "smooth", block: "center" });
    }
  }
  function toggleActivation(enabled) {
    const currentIndex = getPrimaryVisibleImageIndex(getImages(), window.innerHeight);
    isEnabled = enabled;
    localStorage.setItem(STORAGE_KEY_ENABLED, enabled);
    if (enabled) {
      if (currentIndex !== -1) {
        spreadOffset = currentIndex % 2;
      }
      fitImagesToViewport(CONTAINER_SELECTOR, spreadOffset, isDualViewEnabled);
      updatePageCounter();
      if (currentIndex !== -1) {
        const imgs = getImages();
        if (imgs[currentIndex]) imgs[currentIndex].scrollIntoView({ block: "center" });
      }
    } else {
      revertToOriginal(getImages(), CONTAINER_SELECTOR);
    }
    createNavigationUI();
  }
  function scrollToEdge(position) {
    const imgs = getImages();
    if (imgs.length === 0) return;
    const target = position === "start" ? imgs[0] : imgs[imgs.length - 1];
    target.scrollIntoView({ behavior: "smooth", block: "center" });
  }
  function createNavigationUI() {
    const existingStyle = document.getElementById("comic-helper-style");
    if (!existingStyle) {
      const style = document.createElement("style");
      style.id = "comic-helper-style";
      style.textContent = `
      input::-webkit-outer-spin-button,
      input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      input[type=number] {
        -moz-appearance: textfield;
      }
    `;
      document.head.appendChild(style);
    }
    let container = document.getElementById("comic-helper-ui");
    if (!container) {
      let onMouseMove = function(e) {
        if (!isDragging) return;
        const deltaX = e.clientX - dragStartX;
        const deltaY = e.clientY - dragStartY;
        container.style.top = `${initialTop + deltaY}px`;
        container.style.left = `${initialLeft + deltaX}px`;
      }, onMouseUp = function() {
        if (!isDragging) return;
        isDragging = false;
        const rect = container.getBoundingClientRect();
        saveGUIPosition(rect.top, rect.left);
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
      };
      container = document.createElement("div");
      container.id = "comic-helper-ui";
      Object.assign(container.style, {
        position: "fixed",
        bottom: "20px",
        right: "20px",
        zIndex: "10000",
        display: "flex",
        gap: "8px",
        backgroundColor: "rgba(0, 0, 0, 0.7)",
        padding: "8px",
        borderRadius: "8px",
        boxShadow: "0 2px 10px rgba(0,0,0,0.3)",
        cursor: "move",
        userSelect: "none",
        touchAction: "none",
        alignItems: "center",
        whiteSpace: "nowrap",
        width: "max-content"
      });
      const savedPos = loadGUIPosition();
      if (savedPos) {
        Object.assign(container.style, { top: `${savedPos.top}px`, left: `${savedPos.left}px`, bottom: "auto", right: "auto" });
      }
      let isDragging = false;
      let dragStartX, dragStartY, initialTop, initialLeft;
      container.addEventListener("mousedown", (e) => {
        if (e.button !== 0 || e.target.tagName !== "DIV" && e.target !== container) return;
        isDragging = true;
        const rect = container.getBoundingClientRect();
        initialTop = rect.top;
        initialLeft = rect.left;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        Object.assign(container.style, { top: `${initialTop}px`, left: `${initialLeft}px`, bottom: "auto", right: "auto" });
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
        e.preventDefault();
      });
      document.body.appendChild(container);
    }
    container.innerHTML = "";
    const powerBtn = document.createElement("button");
    powerBtn.textContent = "⚡";
    powerBtn.title = isEnabled ? "Disable Comic Viewer Helper" : "Enable Comic Viewer Helper";
    Object.assign(powerBtn.style, {
      cursor: "pointer",
      border: "none",
      background: "transparent",
      color: isEnabled ? "#4CAF50" : "#888",
      fontSize: "16px",
      padding: "0 4px",
      fontWeight: "bold",
      marginRight: isEnabled ? "8px" : "0"
    });
    powerBtn.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      toggleActivation(!isEnabled);
    });
    container.appendChild(powerBtn);
    if (!isEnabled) {
      container.style.padding = "4px 8px";
      return;
    }
    container.style.padding = "8px";
    const counterWrapper = document.createElement("span");
    Object.assign(counterWrapper.style, { color: "#fff", fontSize: "14px", fontWeight: "bold", padding: "0 8px", display: "flex", alignItems: "center", userSelect: "none" });
    pageCounter = document.createElement("input");
    pageCounter.type = "number";
    pageCounter.min = 1;
    Object.assign(pageCounter.style, {
      width: "45px",
      background: "transparent",
      border: "1px solid transparent",
      color: "#fff",
      fontSize: "14px",
      fontWeight: "bold",
      textAlign: "right",
      padding: "2px",
      outline: "none",
      appearance: "textfield",
      margin: "0"
    });
    pageCounter.style.setProperty("-moz-appearance", "textfield");
    pageCounter.addEventListener("focus", () => {
      pageCounter.style.border = "1px solid #fff";
      pageCounter.style.background = "rgba(255,255,255,0.1)";
      pageCounter.select();
    });
    pageCounter.addEventListener("blur", () => {
      pageCounter.style.border = "1px solid transparent";
      pageCounter.style.background = "transparent";
    });
    pageCounter.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        jumpToPage(pageCounter.value);
      }
    });
    const totalCounter = document.createElement("span");
    totalCounter.id = "comic-total-counter";
    totalCounter.textContent = " / 1";
    counterWrapper.appendChild(pageCounter);
    counterWrapper.appendChild(totalCounter);
    container.appendChild(counterWrapper);
    const toggleLabel = document.createElement("label");
    Object.assign(toggleLabel.style, { display: "flex", alignItems: "center", color: "#fff", fontSize: "12px", cursor: "pointer", userSelect: "none", marginRight: "8px" });
    const toggleInput = document.createElement("input");
    toggleInput.type = "checkbox";
    toggleInput.checked = isDualViewEnabled;
    toggleInput.style.marginRight = "4px";
    toggleInput.addEventListener("change", () => {
      toggleDualView(toggleInput.checked);
      toggleInput.blur();
    });
    toggleLabel.appendChild(toggleInput);
    toggleLabel.appendChild(document.createTextNode("Spread"));
    container.appendChild(toggleLabel);
    if (isDualViewEnabled) {
      const adjustBtn = document.createElement("button");
      adjustBtn.textContent = "Adjust";
      adjustBtn.title = "Adjust Spread Alignment";
      Object.assign(adjustBtn.style, {
        cursor: "pointer",
        padding: "2px 6px",
        border: "1px solid #fff",
        background: "transparent",
        color: "#fff",
        borderRadius: "4px",
        fontSize: "10px",
        marginLeft: "4px",
        fontWeight: "normal"
      });
      adjustBtn.onmouseenter = () => adjustBtn.style.background = "rgba(255,255,255,0.2)";
      adjustBtn.onmouseleave = () => adjustBtn.style.background = "transparent";
      adjustBtn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        spreadOffset = spreadOffset === 0 ? 1 : 0;
        fitImagesToViewport(CONTAINER_SELECTOR, spreadOffset, isDualViewEnabled);
        updatePageCounter();
      });
      container.appendChild(adjustBtn);
    }
    const buttons = [
      { text: "<<", label: "Go to First", action: () => scrollToEdge("start") },
      { text: "<", label: "Go to Previous", action: () => scrollToImage(-1) },
      { text: ">", label: "Go to Next", action: () => scrollToImage(1) },
      { text: ">>", label: "Go to Last", action: () => scrollToEdge("end") }
    ];
    buttons.forEach((btnDef) => {
      const btn = document.createElement("button");
      btn.textContent = btnDef.text;
      btn.title = btnDef.label;
      Object.assign(btn.style, { cursor: "pointer", padding: "6px 12px", border: "none", background: "#fff", color: "#333", borderRadius: "4px", fontSize: "12px", fontWeight: "bold", minWidth: "50px" });
      btn.onmouseenter = () => btn.style.background = "#eee";
      btn.onmouseleave = () => btn.style.background = "#fff";
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();
        btnDef.action();
        btn.blur();
      });
      container.appendChild(btn);
    });
  }
  function onKeyDown(e) {
    if (isInputField(e.target) || e.ctrlKey || e.metaKey || e.altKey) return;
    if (!isEnabled) return;
    if (["ArrowDown", "PageDown", "ArrowRight", "j"].includes(e.key) || e.key === " " && !e.shiftKey) {
      e.preventDefault();
      scrollToImage(1);
    } else if (["ArrowUp", "PageUp", "ArrowLeft", "k"].includes(e.key) || e.key === " " && e.shiftKey) {
      e.preventDefault();
      scrollToImage(-1);
    } else if (e.key === "d") {
      e.preventDefault();
      const newState = !isDualViewEnabled;
      const checkbox = document.querySelector('input[type="checkbox"]');
      if (checkbox) checkbox.checked = newState;
      toggleDualView(newState);
    }
  }
  function toggleDualView(enabled) {
    const currentIndex = getPrimaryVisibleImageIndex(getImages(), window.innerHeight);
    isDualViewEnabled = enabled;
    localStorage.setItem(STORAGE_KEY_DUAL_VIEW, enabled);
    if (enabled) {
      if (currentIndex !== -1) {
        spreadOffset = currentIndex % 2;
      }
    }
    fitImagesToViewport(CONTAINER_SELECTOR, spreadOffset, isDualViewEnabled);
    updatePageCounter();
    createNavigationUI();
    if (currentIndex !== -1) {
      const imgs = getImages();
      const targetImg = imgs[currentIndex];
      if (targetImg) targetImg.scrollIntoView({ block: "center" });
    }
  }
  function saveGUIPosition(top, left) {
    localStorage.setItem(STORAGE_KEY_GUI_POS, JSON.stringify({ top, left }));
  }
  function loadGUIPosition() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY_GUI_POS);
      if (!saved) return null;
      const pos = JSON.parse(saved);
      const buffer = 50;
      if (pos.left < -buffer || pos.left > window.innerWidth + buffer || pos.top < -buffer || pos.top > window.innerHeight + buffer) return null;
      return pos;
    } catch {
      return null;
    }
  }
  function init() {
    const container = document.querySelector(CONTAINER_SELECTOR);
    if (!container) return;
    originalImages = Array.from(document.querySelectorAll(IMG_SELECTOR));
    const imgs = document.querySelectorAll(IMG_SELECTOR);
    let resizeReq;
    imgs.forEach((img) => {
      if (!img.complete) {
        img.addEventListener("load", () => {
          if (resizeReq) cancelAnimationFrame(resizeReq);
          resizeReq = requestAnimationFrame(() => {
            if (isEnabled) {
              fitImagesToViewport(CONTAINER_SELECTOR, spreadOffset, isDualViewEnabled);
              updatePageCounter();
            }
          });
        });
      }
    });
    if (isEnabled) {
      fitImagesToViewport(CONTAINER_SELECTOR, spreadOffset, isDualViewEnabled);
    }
    createNavigationUI();
    if (isEnabled) {
      updatePageCounter();
    }
    window.addEventListener("resize", () => {
      if (!isEnabled) return;
      if (resizeReq) cancelAnimationFrame(resizeReq);
      resizeReq = requestAnimationFrame(() => {
        fitImagesToViewport(CONTAINER_SELECTOR, spreadOffset, isDualViewEnabled);
        updatePageCounter();
      });
    });
    let scrollReq;
    window.addEventListener("scroll", () => {
      if (!isEnabled) return;
      if (scrollReq) cancelAnimationFrame(scrollReq);
      scrollReq = requestAnimationFrame(updatePageCounter);
    });
    document.addEventListener("keydown", onKeyDown, true);
  }
  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", init);
  else init();
})();
