## Context

サイト側のスクリプトは `<a>` クリック時に `window.open()` で新タブ（広告）を開き、現在のタブを別の広告URLにリダイレクトするポップアンダー手法を採用している。現在のビューアにはこれを抑制する仕組みがない。

既存のマネージャーパターン（`InputManager`, `Navigator`, `UIManager`, `ResumeManager`）に合わせ、単一責務の新規クラスとして実装する。

## Goals / Non-Goals

**Goals:**
- `<a>` クリック時のポップアンダー広告リダイレクトを抑制する
- サイト側スクリプトの実行を、キャプチャフェーズで先に止める
- 既存のマネージャーの動作を変えない

**Non-Goals:**
- `window.open()` オーバーライドによる新タブ開く側の制御（今後の別イシューで検討）
- 広告の検出や分類
- サイト側の正当なUI動作（ドロップダウンメニュー等）の修復（現時点では `<a>` クリックの一般的な除外条件で対応）

## Decisions

### イベント受付の仕組み
**決定**: `document.addEventListener('click', handler, true)` でキャプチャフェーズにリスナーを登録する。

**Rationale**: サイト側スクリプトはバブルフェーズで動いている前提で、キャプチャフェーズで先に `stopImmediatePropagation()` を呼ぶことで他のハンドラに伝達しない。`InputManager` でも既に `keydown` がキャプチャフェーズで登録されており、プロジェクト内の先例がある。

### クラス設計
**決定**: `PopUnderBlocker` を `src/managers/` に新規クラスとして作成し、`main.js` で他のマネージャーと同じ粒度で初期化する。

**理由**: イシュー #103 の検討事項で指摘されている通り、将来サイト構成や対象サイトが変わった際に広告対策だけを別途修正・拡張できるようにする。`InputManager` に混ぜると「入力管理」という名前と責務が大きくはみ出す。

**candidates considered**:
- `InputManager` に追加 → 責務混在、テスト焦点が散る
- `PopUnderBlocker` を新規クラスとして作る → 採用

### 除外条件
**決定**: 以下の場合はインターセプトしない。
1. `target="_blank"` が明示されているリンク（ユーザーの意図である可能性がある）
2. `Ctrl` または `Meta` キーが押されている場合（別タブで開くユーザー操作）
3. `javascript:` リンク（実行スコープの問題）

**理由**: これらは通常のポップアンダー広告ではなくユーザーの意図による遷移であるため、インターセプトすると正常動作を壊す可能性がある。いずれも問題になった場合に個別に見直すことを予定とする。

### `enabled` フラグの連携
**決定**: `store` の `enabled` フラグで機能のオン/オフを制御する。

**理由**: 他のマネージャーと同じ制御パターンで一貫性を保つ。

## Risks / Trade-offs

- [全リンクをインターセプトすると正当なUI動作を壊す可能性がある] → 除外条件で対応。問題が発生した場合は除外リストを拡張する。
- [`window.open()` 側の制御をしないため、新タブ側の広告が開く可能性が残る] → 現時点では `<a>` インターセプトのみで対策の効果を観察し、必要に応じて別イシューで対応する。