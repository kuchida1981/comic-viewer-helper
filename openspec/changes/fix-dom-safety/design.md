## Context

現在の `src/logic.ts` などの DOM 操作関数は、要素が存在すること、および必要なメソッド（`getBoundingClientRect` 等）が実装されていることを前提としています。
UserScript は動的なウェブサイト上で動作するため、サイト側の仕様変更や遅延読み込み、拡張機能同士の競合などにより、予期せぬタイミングで要素が消失したり、不完全な状態のオブジェクトが渡されたりするリスクがあります。

## Goals / Non-Goals

**Goals:**
- 主要な DOM 操作関数におけるランタイムエラー（`TypeError: Cannot read property...`）の撲滅。
- 異常系・エッジケースを考慮したテストコードの拡充。
- Optional Chaining (`?.`) や明示的なガード節を用いた、クリーンで堅牢なコードへのリファクタリング。

**Non-Goals:**
- パフォーマンスに影響を与えるような過剰なチェック（ループ内での冗長な検証など）。
- ロジック自体の大幅な変更（アルゴリズムの変更は行わず、安全性の向上に留める）。

## Decisions

### 1. Optional Chaining と明示的なガード節の併用
単純なプロパティアクセスには Optional Chaining を使用し、処理の継続が不可能な場合には早期リターン（ガード節）を使用します。

**Rationale:**
コードの可読性を維持しつつ、安全性を確保するため。

### 2. getPrimaryVisibleImageIndex におけるデフォルト値の返却
画像リストが空、あるいは要素が不正な場合、例外を投げずに `-1` を返却するように統一します。

**Rationale:**
呼び出し側で `-1`（該当なし）を適切にハンドリングできる設計になっているため。

### 3. fitImagesToViewport における要素スキップ
不正な画像要素（`img` ではない、あるいは必要なプロパティが欠損している）が含まれている場合、その要素の処理をスキップし、他の正常な画像のレイアウトを継続します。

**Rationale:**
一部の要素の不具合によってページ全体の閲覧体験が損なわれるのを防ぐため。

### 4. ブラウザ API の存在確認
`img.decode` や `loading` 属性など、全ての環境でサポートされているとは限らない機能については、事前に存在確認を行います。

## Risks / Trade-offs

- **[Risk]** コードベースにチェック処理が増えることによる微小なオーバーヘッド。
  - **Mitigation**: クリティカルパス以外のチェックは最小限に留め、JITコンパイラの最適化を妨げない簡潔な記述を心がける。
- **[Risk]** テストコードの肥大化。
  - **Mitigation**: 共通のモック生成ロジックを活用し、テストの意図（どの異常系をテストしているか）が明確な構成にする。
