## Context

現在の `comic-viewer-helper.user.js` は、画像を単純に縦に並べる（または1つずつ表示する）シンプルなビューワーです。
見開き表示を実装するためには、画像のレンダリングパイプラインを変更し、動的に画像のペアリングを行う必要があります。
また、ユーザーがこの機能を制御できるようにするためのUIと状態管理を追加する必要があります。

## Goals / Non-Goals

**Goals:**
*   条件に合致する画像を左右に見開き配置（右：前、左：次）するロジックの実装。
*   横長画像（すでに見開きになっている画像など）を検知し、強制的に単ページ表示にする。
*   ユーザーによる見開きモードのON/OFF切り替え（GUI & ショートカット）。
*   見開きモードの状態を維持する（ブラウザリロード後も設定を記憶）。

**Non-Goals:**
*   右開き以外の読み方向（左開きなど）のサポート（今回は日本の漫画＝右開き固定）。
*   複雑なアニメーション効果（ページめくりアニメーションなど）。
*   モバイル端末での見開き表示最適化（今回はPC/ワイドスクリーンを主眼）。

## Decisions

### 1. レンダリングロジックの変更
現在の「各画像を独立して処理する」ループから、「画像を順走査し、ペアリングを決定して描画する」ロジックへ変更します。

*   **アプローチ**: `renderImages()` のような関数内で、現在の画像インデックス `i` から開始し：
    *   画像 `i` が横長（`width > height`） → 単独表示行を作成、`i` をインクリメント。
    *   画像 `i` が縦長 かつ 次の画像 `i+1` が存在し、それも縦長 → ペア表示行を作成（右: `i`, 左: `i+1`）、`i` を +2 インクリメント。
    *   それ以外（最後の1枚など） → 単独表示行を作成、`i` をインクリメント。
*   **理由**: 事前に固定ペアを作るのではなく、動的に判定することで、途中に横長ページが混ざっても柔軟に対応できるため。

### 2. 横長画像の判定基準
*   **基準**: `image.naturalWidth > image.naturalHeight`
*   **理由**: 漫画の原稿において、見開きページは明確に横長であり、通常のページは縦長であるため、単純なアスペクト比比較で十分機能する。

### 3. 設定の永続化
*   **方法**: `localStorage` を使用して `isDualViewEnabled` の状態を保存する。
*   **キー名**: `comic-viewer-helper-dual-view`
*   **理由**: ページ遷移やリロードのたびに設定し直すのはユーザー体験を著しく損なうため。

### 4. キーボードショートカット
*   **キー**: `d`
*   **理由**: "Dual" の頭文字であり、既存の矢印キーやSpaceキーと競合せず、左手（WASD付近）でも押しやすいため。

## Risks / Trade-offs

*   **Risk**: 画像の読み込み遅延により `naturalWidth/Height` が取得できない場合、判定が狂う可能性がある。
    *   **Mitigation**: 画像がロードされるまで待機する、あるいは `onload` イベントで再レイアウトをトリガーする既存の仕組み（`fitImagesToViewport`）を活用する。既存コードですでに `resize` や `scroll` で調整しているので、そこに統合する。

*   **Risk**: コンテナの幅が狭すぎる場合、見開きにすると画像が小さくなりすぎる。
    *   **Mitigation**: 今回は明示的なレスポンシブ制限（「スマホでは無効化」など）は設けないが、ユーザーがトグルでOFFにできるため許容する。
