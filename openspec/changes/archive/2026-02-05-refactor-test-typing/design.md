## Context

現在のテストコード（`src/**/*.test.ts`）は、TypeScriptへの移行過程で一時的に `// @ts-nocheck` が導入され、型チェックがスキップされています。これにより、Vitest のモックオブジェクトやグローバル変数の操作が型安全ではなくなっており、メンテナンス性の低下を招いています。

## Goals / Non-Goals

**Goals:**
- すべてのテストファイルから `// @ts-nocheck` を排除し、`npm run check-types` をパスさせる。
- `vi.mock` や `vi.stubGlobal` で作成されるモックに適切な型を適用し、インテリセンスの恩恵を受けられるようにする。
- 共通のモック（`localStorage` など）に対する型安全なヘルパーを導入し、重複を排除する。

**Non-Goals:**
- テストケース自体のロジック変更や、テスト対象コードのリファクタリング（型エラー修正に必要な最小限の変更を除く）。
- テストフレームワーク（Vitest）自体の変更。

## Decisions

### 1. `vi.mocked()` の活用
モック化した関数のプロパティ（`mockReturnValue` など）にアクセスする際、明示的なキャストを避けるために `vi.mocked()` を使用します。

### 2. グローバルオブジェクトのスタブ化
`vi.stubGlobal` で `document` や `window` を上書きするのではなく、可能な限り `jsdom` が提供する環境をそのまま利用し、必要なプロパティのみを `vi.spyOn` や `vi.fn()` でモックします。

### 3. localStorage モックの共通化
多くのテストで必要とされる `localStorage` のモックを、型安全なユーティリティ（例: `src/test/mocks/storage.ts` ※新規作成検討）または `beforeEach` 内での標準化されたパターンとして定義します。

### 4. DOM要素の型付け
`createElement` のモックが返すオブジェクトについて、単純な `{ style: {} }` ではなく、最小限の `HTMLElement` プロパティを備えたオブジェクトとして定義するか、`as unknown as HTMLElement` による安全なキャスト（ただし検証に必要なプロパティは網羅する）を行います。

## Risks / Trade-offs

- **[Risk]** 型エラーを修正する過程で、テストの意図（何を検証しているか）が変化してしまう。
  - **Mitigation:** 各ファイルの修正後に必ずテストを実行し、既存のテスト結果が維持されていることを確認する。
- **[Risk]** モックの型定義が複雑になりすぎ、テストコードの可読性が下がる。
  - **Mitigation:** `any` を完全に排除するのではなく、ESLintで許容されている範囲内でバランスを取る。ただし `// @ts-nocheck` によるファイル全体の無効化は禁止する。
