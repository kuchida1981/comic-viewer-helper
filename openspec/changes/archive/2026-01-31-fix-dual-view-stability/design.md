## Context

現在の実装では、見開き表示（Dual View）のペアリングロジックが閲覧位置（`alignmentIndex`）に依存しており、ページを移動するたびにペアリングが変わるという不安定な挙動を示しています。また、リサイズ時にDOM要素が増殖する問題や、設定がリセットされるバグも存在します。
これらを解決し、ユーザーが意図した通りに見開きを制御できる仕組みが必要です。

## Goals / Non-Goals

**Goals:**
*   見開きペアリングを「閲覧位置」から切り離し、`spreadOffset` (0/1) という状態変数によって一意に定まるようにする（決定論的レンダリング）。
*   ユーザーが「Adjust」ボタンで手動でオフセットを調整できるようにする。
*   見開きON/OFF切り替え時に、現在ページを起点とする最適なオフセットを自動設定する。
*   リサイズや再描画によるDOM汚染（空要素の残留）を解消する。

**Non-Goals:**
*   横長画像が混在する場合の複雑なペアリング最適化（現状の単純なロジックを維持）。
*   見開きオフセット設定の永続化（`localStorage` への保存は行わず、セッション内での維持に留める）。

## Decisions

### 1. 状態管理の責務
`spreadOffset` (0 または 1) の状態管理は `main.js` で行う。
`logic.js` の `fitImagesToViewport` 関数は、この値を引数として受け取る純粋なレンダラーに近い挙動とする。
*   **Rationale**: `logic.js` をステートレスに保つことでテスト容易性を維持するため。

### 2. 初期オフセットの自動計算
Dual View を有効化する際、現在表示中のページインデックス (`currentIndex`) に基づいて初期オフセットを決定する。
*   **Logic**: 基本的に `currentIndex % 2` を初期オフセットとする。
    *   偶数ページ (0, 2, 4...) なら Offset 0 ([0-1], [2-3]...)
    *   奇数ページ (1, 3, 5...) なら Offset 1 ([0], [1-2], [3-4]...)
*   **Rationale**: これにより、ユーザーが見ているページが「見開きの右側（開始）」に来る確率が高まる。もし意図と違っても、後述のAdjust機能で修正可能。

### 3. DOM再構築戦略
`fitImagesToViewport` の実行冒頭で、必ず **DOMのクリーンアップ（フラット化）** を行う。
*   **Logic**:
    1.  コンテナ内の全ての画像を一時配列に退避。
    2.  コンテナ内の既存のラッパー要素 (`.comic-row-wrapper`) を全て削除。
    3.  画像を再配置（ペアリングまたは単独配置）。
*   **Rationale**: これにより、リサイズや再描画を何度繰り返してもDOM要素が増殖せず、常にクリーンな状態が保たれる。

### 4. UI実装
`createNavigationUI` に「Adjust」ボタン（アイコン等）を追加する。
*   このボタンは `isDualViewEnabled` が true の時のみ表示（または有効化）される。
*   クリック時、`spreadOffset` を反転 (0⇔1) させ、即座に `fitImagesToViewport` を呼び出す。

## Risks / Trade-offs

*   **Risk**: DOMの全再構築は、画像枚数が非常に多い場合（数千枚など）にパフォーマンスコストがかかる可能性がある。
    *   **Mitigation**: 一般的なWeb漫画のページ数（数十〜百枚程度）では問題ないレベルと想定。重い場合は `requestAnimationFrame` での分割などを検討するが、今回はシンプルさを優先。
*   **Trade-off**: `revertToOriginal` 相当の処理を毎回行うため、元サイトのDOM構造（画像以外の要素の並び）が完全に復元されるわけではない（末尾に追加される仕様は維持）。
    *   これはUserscriptの制約として許容する。
